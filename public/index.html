<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Condominio</title>
    <link rel="stylesheet" href="/output.css">
</head>
<body class="bg-gray-100">

    <!-- ====== Sección de Autenticación - Inicio ====== -->
    <div id="auth-container" class="flex items-center justify-center min-h-screen">
        <div class="bg-white p-8 rounded-lg shadow-md w-full max-w-sm">
            <h1 class="text-2xl font-bold mb-6 text-center text-gray-800">Bienvenido</h1>
            <div class="mb-4">
                <label for="email" class="block text-gray-700 text-sm font-bold mb-2">Correo Electrónico</label>
                <input type="email" id="email" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="tu@email.com">
            </div>
            <div class="mb-6">
                <label for="password" class="block text-gray-700 text-sm font-bold mb-2">Contraseña</label>
                <input type="password" id="password" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline" placeholder="******************">
            </div>
            <div class="flex flex-col space-y-2">
                <button id="loginButton" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">Iniciar Sesión</button>
                <button id="registerButton" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">Registrarse</button>
            </div>
            <div class="relative flex py-5 items-center"><div class="flex-grow border-t border-gray-300"></div><span class="flex-shrink mx-4 text-gray-400 text-xs">O</span><div class="flex-grow border-t border-gray-300"></div></div>
            <div class="flex flex-col">
                 <button id="googleLoginButton" class="bg-white hover:bg-gray-100 text-gray-800 font-semibold py-2 px-4 border border-gray-300 rounded shadow flex items-center justify-center">
                    <svg class="w-4 h-4 mr-2" aria-hidden="true" focusable="false" viewBox="0 0 488 512"><path fill="currentColor" d="M488 261.8C488 403.3 381.5 512 244 512 111.3 512 0 398.5 0 256S111.3 0 244 0c69.9 0 131.5 28.4 176.9 75.3L345 151.5C318.2 128.2 282.7 112 244 112c-88.6 0-160.1 71.7-160.1 160.1s71.4 160.1 160.1 160.1c97.4 0 134-60.3 138.6-93.1H244v-74.3h236.1c2.3 12.7 3.9 26.9 3.9 41.4z"></path></svg>
                    Iniciar Sesión con Google
                </button>
            </div>
            <p id="error-message" class="text-red-500 text-xs italic mt-4 text-center"></p>
        </div>
    </div>
    <!-- ====== Sección de Autenticación - Fin ====== -->


    <!-- ====== Sección del Dashboard - Inicio ====== -->
    <div id="dashboard-container" class="hidden p-4 md:p-8">
        <header class="flex justify-between items-center mb-8">
            <h1 id="welcome-message" class="text-2xl md:text-3xl font-bold text-gray-800"></h1>
            <button id="logoutButton" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">Cerrar Sesión</button>
        </header>

        <main>
            <!-- ====== Sub-sección: Resumen Financiero - Inicio ====== -->
            <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                <h2 id="property-name" class="text-xl font-semibold text-gray-700 mb-2"></h2>
                <p class="text-gray-600">Saldo Actual</p>
                <p id="property-balance" class="text-4xl font-bold"></p>
            </div>
            <!-- ====== Sub-sección: Resumen Financiero - Fin ====== -->

            <!-- ====== Sub-sección: Historial de Transacciones - Inicio ====== -->
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Historial de Transacciones</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full leading-normal">
                        <thead>
                            <tr>
                                <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Fecha</th>
                                <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Descripción</th>
                                <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">Monto</th>
                            </tr>
                        </thead>
                        <tbody id="transactions-table-body">
                            <!-- Las filas de transacciones se insertarán aquí -->
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- ====== Sub-sección: Historial de Transacciones - Fin ====== -->
        </main>
    </div>
    <!-- ====== Sección del Dashboard - Fin ====== -->

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, getAdditionalUserInfo } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, query, where, orderBy, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- Configuración de Firebase ---
        const firebaseConfig = {
            apiKey: "AIzaSyAfb-hN3jJSaPHZ3JMVJyXIjkIc_-NPyGg",
            authDomain: "alboradakpi.firebaseapp.com",
            projectId: "alboradakpi",
            storageBucket: "alboradakpi.appspot.com",
            messagingSenderId: "137214990147",
            appId: "1:137214990147:web:09ed9f77b6830a997601f6",
            measurementId: "G-Y23MSYLH7B"
        };

        // --- Inicialización de Servicios ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Referencias al DOM ---
        const authContainer = document.getElementById('auth-container');
        const dashboardContainer = document.getElementById('dashboard-container');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const loginButton = document.getElementById('loginButton');
        const registerButton = document.getElementById('registerButton');
        const googleLoginButton = document.getElementById('googleLoginButton');
        const logoutButton = document.getElementById('logoutButton');
        const errorMessageElement = document.getElementById('error-message');

        // --- Lógica Principal (Observador de Autenticación) ---
        /**
         * @summary Observador principal del estado de autenticación.
         * @description Se activa cuando un usuario inicia o cierra sesión.
         *              Controla qué contenedor principal se muestra (autenticación o dashboard).
         * @param {firebase.User|null} user - El objeto de usuario de Firebase si está autenticado, o null si no lo está.
         */
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // Usuario ha iniciado sesión
                authContainer.classList.add('hidden');
                dashboardContainer.classList.remove('hidden');
                loadDashboardData(user);
            } else {
                // Usuario ha cerrado sesión
                authContainer.classList.remove('hidden');
                dashboardContainer.classList.add('hidden');
                clearDashboardData();
            }
        });

        // --- Funciones del Dashboard ---
        /**
         * @summary Carga y muestra los datos del dashboard para el usuario autenticado.
         * @description Obtiene el perfil del usuario, la información de su propiedad (saldo, nombre)
         *              y su historial de transacciones desde Firestore, y los renderiza en el DOM.
         * @param {firebase.User} user - El objeto del usuario autenticado.
         * @async
         */
        async function loadDashboardData(user) {
            document.getElementById('welcome-message').textContent = `Bienvenido, ${user.displayName || user.email}`;
            
            try {
                // 1. Obtener el perfil del usuario para encontrar su propertyId
                const userDocRef = doc(db, "users", user.uid);
                const userDoc = await getDoc(userDocRef);

                if (!userDoc.exists() || !userDoc.data().propertyId || userDoc.data().propertyId === 'PENDING_ASSIGNMENT') {
                    document.getElementById('property-name').textContent = 'Propiedad no asignada';
                    document.getElementById('property-balance').textContent = 'N/A';
                    return;
                }
                const propertyId = userDoc.data().propertyId;

                // 2. Obtener la información de la propiedad (saldo y nombre)
                const propDocRef = doc(db, "properties", propertyId);
                const propDoc = await getDoc(propDocRef);

                if (propDoc.exists()) {
                    const propertyData = propDoc.data();
                    document.getElementById('property-name').textContent = propertyData.name || 'Mi Propiedad';
                    const balance = propertyData.balance || 0;
                    const balanceElement = document.getElementById('property-balance');
                    balanceElement.textContent = new Intl.NumberFormat('es-PA', { style: 'currency', currency: 'USD' }).format(balance);
                    balanceElement.className = balance >= 0 ? 'text-4xl font-bold text-green-600' : 'text-4xl font-bold text-red-600';
                }

                // 3. Obtener el historial de transacciones
                const transactionsTableBody = document.getElementById('transactions-table-body');
                const q = query(collection(db, "transactions"), where("propertyId", "==", propertyId), orderBy("createdAt", "desc"));
                const querySnapshot = await getDocs(q);
                
                querySnapshot.forEach(doc => {
                    const tx = doc.data();
                    const row = transactionsTableBody.insertRow();
                    row.className = 'border-b border-gray-200';

                    const dateCell = row.insertCell(0);
                    dateCell.className = 'px-5 py-5 text-sm';
                    dateCell.textContent = tx.createdAt.toDate().toLocaleDateString('es-PA');

                    const descCell = row.insertCell(1);
                    descCell.className = 'px-5 py-5 text-sm';
                    descCell.textContent = tx.description;

                    const amountCell = row.insertCell(2);
                    amountCell.className = `px-5 py-5 text-sm text-right font-semibold ${tx.amount >= 0 ? 'text-green-600' : 'text-red-600'}`;
                    amountCell.textContent = new Intl.NumberFormat('es-PA', { style: 'currency', currency: 'USD' }).format(tx.amount);
                });

            } catch (error) {
                console.error("Error cargando datos del dashboard:", error);
                document.getElementById('property-name').textContent = 'Error al cargar datos.';
            }
        }

        /**
         * @summary Limpia los datos del dashboard.
         * @description Se ejecuta al cerrar sesión para eliminar la información sensible
         *              y resetear la interfaz del dashboard.
         */
        function clearDashboardData() {
            document.getElementById('welcome-message').textContent = '';
            document.getElementById('property-name').textContent = '';
            document.getElementById('property-balance').textContent = '';
            document.getElementById('transactions-table-body').innerHTML = '';
        }

        // Maneja el evento de clic para el botón de cerrar sesión.
        logoutButton.addEventListener('click', () => {
            signOut(auth).catch(error => console.error('Error al cerrar sesión:', error));
        });

        // --- Funciones de Autenticación ---
        /**
         * @summary Crea un documento de perfil de usuario en Firestore.
         * @description Tras un registro exitoso (ya sea por email/contraseña o proveedor social),
         *              esta función crea un documento en la colección 'users' con información básica
         *              y un 'propertyId' pendiente de asignación.
         * @param {firebase.User} user - El objeto de usuario recién creado por Firebase Auth.
         * @async
         */
        async function createUserProfile(user) {
            const userDocRef = doc(db, "users", user.uid);
            await setDoc(userDocRef, {
                email: user.email,
                displayName: user.displayName || user.email.split('@')[0],
                role: 'resident',
                propertyId: 'PENDING_ASSIGNMENT',
                createdAt: serverTimestamp()
            });
            console.log("Documento de usuario creado en Firestore.");
        }

        // Maneja el evento de clic para el botón de registro.
        registerButton.addEventListener('click', () => {
            const email = emailInput.value;
            const password = passwordInput.value;
            errorMessageElement.textContent = '';
            createUserWithEmailAndPassword(auth, email, password)
                .then(async (userCredential) => {
                    await createUserProfile(userCredential.user);
                    alert('¡Registro exitoso!');
                })
                .catch((error) => { errorMessageElement.textContent = `Error: ${error.message}`; });
        });

        // Maneja el evento de clic para el botón de inicio de sesión.
        loginButton.addEventListener('click', () => {
            const email = emailInput.value;
            const password = passwordInput.value;
            errorMessageElement.textContent = '';
            signInWithEmailAndPassword(auth, email, password)
                .catch((error) => { errorMessageElement.textContent = `Error: ${error.message}`; });
        });

        // Maneja el evento de clic para el botón de inicio de sesión con Google.
        googleLoginButton.addEventListener('click', () => {
            const provider = new GoogleAuthProvider();
            errorMessageElement.textContent = '';
            signInWithPopup(auth, provider)
                .then(async (result) => {
                    const additionalInfo = getAdditionalUserInfo(result);
                    if (additionalInfo.isNewUser) {
                        await createUserProfile(result.user);
                    }
                }).catch((error) => { errorMessageElement.textContent = `Error: ${error.message}`; });
        });

    </script>

</body>
</html>